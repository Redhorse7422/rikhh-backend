# üî• Firebase to PostgreSQL Migration Guide

This guide will help you migrate your data from Firebase to PostgreSQL while maintaining data relationships using the `documentId` field.

## üìã Prerequisites

1. **Firebase Service Account**: You need a Firebase service account key file
2. **PostgreSQL Database**: Your database should be running and accessible
3. **Environment Setup**: Configure all required environment variables
4. **Dependencies**: Install Firebase Admin SDK

## üöÄ Quick Start

### 1. Install Dependencies

```bash
# Install Firebase Admin SDK
yarn add firebase-admin

# Install types for Firebase Admin
yarn add -D @types/firebase-admin
```

### 2. Environment Configuration

Copy the `env.template` file to `.env` and fill in your Firebase credentials:

```bash
cp env.template .env
```

**Required Firebase Environment Variables:**
```env
FIREBASE_PROJECT_ID=your-firebase-project-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYour private key here\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=your-service-account@your-project.iam.gserviceaccount.com
FIREBASE_DATABASE_URL=https://your-project.firebaseio.com
```

### 3. Get Firebase Service Account Key

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project
3. Go to Project Settings ‚Üí Service Accounts
4. Click "Generate New Private Key"
5. Download the JSON file
6. Extract the values to your `.env` file

## üîÑ Migration Process

### Phase 1: Seller Migration (Current Focus)

The seller migration is implemented and ready to use. It handles:

- ‚úÖ Data fetching from Firebase Firestore
- ‚úÖ Data transformation and validation
- ‚úÖ PostgreSQL insertion with UUID generation
- ‚úÖ Firebase document ID preservation in `documentId` field
- ‚úÖ Duplicate detection and skipping
- ‚úÖ Comprehensive error handling and reporting

### Phase 2: Other Entities (Future Implementation)

The following entities will be migrated in order:

1. **Permissions** (no dependencies)
2. **Roles** (depends on permissions)
3. **Users** (depends on roles)
4. **Addresses** (depends on users)
5. **Sellers** (depends on users) ‚úÖ **COMPLETED**
6. **Categories** (no dependencies)
7. **Media Files** (no dependencies)
8. **Products** (depends on sellers, categories, media)
9. **Attributes** (depends on products)
10. **Carts** (depends on users, products)
11. **Coupons** (no dependencies)
12. **Orders** (depends on users, sellers)
13. **Order Items** (depends on orders, products)

## üõ†Ô∏è Running the Migration

### Seller Migration Only

```bash
# Run seller migration
yarn ts-node src/scripts/migrate-sellers.ts

# Run with verbose logging
yarn ts-node src/scripts/migrate-sellers.ts --verbose

# Show help
yarn ts-node src/scripts/migrate-sellers.ts --help
```

### Full Migration (When Implemented)

```bash
# Run complete migration
yarn ts-node src/scripts/firebase-migration.ts

# Dry run (no actual database changes)
yarn ts-node src/scripts/firebase-migration.ts --dry-run

# Skip existing records
yarn ts-node src/scripts/firebase-migration.ts --skip-existing
```

## üìä Migration Features

### Data Integrity
- **Batch Processing**: Processes data in configurable batches (default: 100)
- **Duplicate Prevention**: Checks `documentId` field before insertion
- **Error Handling**: Continues migration even if individual records fail
- **Transaction Safety**: Each record is processed in its own transaction

### Data Transformation
- **Date Parsing**: Handles Firebase Timestamp objects and various date formats
- **Enum Mapping**: Maps Firebase string values to PostgreSQL enum types
- **Null Handling**: Safely handles missing or undefined fields
- **Type Conversion**: Converts Firebase data types to PostgreSQL types

### Monitoring & Reporting
- **Real-time Progress**: Shows migration progress with batch information
- **Detailed Logging**: Configurable log levels (debug, info, warn, error)
- **Error Tracking**: Maintains list of failed migrations with error details
- **Final Report**: Comprehensive summary of migration results

## üîç Data Structure Mapping

### Firebase ‚Üí PostgreSQL

| Firebase Field | PostgreSQL Field | Type | Notes |
|----------------|------------------|------|-------|
| `id` | `documentId` | string | Firebase document ID preserved |
| `userId` | `userId` | string | References user table |
| `businessName` | `businessName` | string | Business name |
| `status` | `status` | enum | Mapped to SELLER_STATUS |
| `verificationStatus` | `verificationStatus` | enum | Mapped to SELLER_VERIFICATION_STATUS |
| `createdAt` | `createdAt` | timestamp | Auto-generated by BaseEntity |
| `updatedAt` | `updatedAt` | timestamp | Auto-generated by BaseEntity |

### Generated Fields

| Field | Type | Source |
|-------|------|---------|
| `id` | UUID | Auto-generated by PostgreSQL |
| `createdAt` | timestamp | Current timestamp |
| `updatedAt` | timestamp | Current timestamp |

## ‚ö†Ô∏è Important Considerations

### 1. Data Relationships
- **User References**: Ensure users are migrated before sellers
- **Foreign Keys**: Migration order respects foreign key constraints
- **Circular Dependencies**: Handled through proper migration sequence

### 2. Data Validation
- **Required Fields**: Non-nullable fields are validated before insertion
- **Enum Values**: Invalid enum values are mapped to defaults
- **Date Formats**: Various date formats are supported and parsed

### 3. Performance
- **Batch Processing**: Configurable batch sizes for memory management
- **Connection Pooling**: Efficient database connection handling
- **Error Isolation**: Individual record failures don't stop the migration

### 4. Rollback Strategy
- **documentId Field**: Firebase IDs are preserved for reference
- **Dry Run Mode**: Test migration without database changes
- **Incremental Migration**: Skip existing records to resume interrupted migrations

## üß™ Testing the Migration

### 1. Dry Run
```bash
yarn ts-node src/scripts/migrate-sellers.ts --dry-run
```

### 2. Small Batch Test
```bash
# Modify batch size in the script for testing
private readonly CHECKOUT_SESSION_TTL = 10; // Small batch for testing
```

### 3. Verify Data
```sql
-- Check migrated sellers
SELECT id, documentId, businessName, status FROM sellers;

-- Verify documentId uniqueness
SELECT documentId, COUNT(*) FROM sellers GROUP BY documentId HAVING COUNT(*) > 1;
```

## üö® Troubleshooting

### Common Issues

1. **Firebase Connection Failed**
   - Verify service account credentials
   - Check project ID and database URL
   - Ensure Firebase Admin SDK is properly initialized

2. **Database Connection Failed**
   - Verify PostgreSQL connection details
   - Check database exists and is accessible
   - Verify user permissions

3. **Data Type Mismatches**
   - Check enum value mappings
   - Verify date format parsing
   - Review field type conversions

4. **Memory Issues**
   - Reduce batch size
   - Monitor memory usage during migration
   - Consider processing in smaller chunks

### Debug Mode

```bash
# Enable debug logging
yarn ts-node src/scripts/migrate-sellers.ts --debug

# Check detailed error information
# Review migration logs for specific failure reasons
```

## üìà Next Steps

After successfully migrating sellers:

1. **Verify Data Integrity**: Check that all seller data is correctly migrated
2. **Test Relationships**: Ensure user-seller relationships work correctly
3. **Update Application Code**: Remove Firebase dependencies from seller-related code
4. **Plan Next Entity**: Choose the next entity to migrate (recommended: Users)
5. **Monitor Performance**: Ensure PostgreSQL queries perform well with new data

## ü§ù Support

If you encounter issues:

1. Check the error logs for specific failure details
2. Verify your environment configuration
3. Test with a small subset of data first
4. Review the migration script for any customizations needed

## üìö Additional Resources

- [Firebase Admin SDK Documentation](https://firebase.google.com/docs/admin/setup)
- [TypeORM Documentation](https://typeorm.io/)
- [PostgreSQL UUID Extension](https://www.postgresql.org/docs/current/uuid-ossp.html)
- [Node.js Environment Variables](https://nodejs.org/api/process.html#processenv)

---

**Happy Migrating! üéâ**

Remember: Start with sellers, verify everything works, then move to the next entity. This incremental approach ensures a smooth transition from Firebase to PostgreSQL.
